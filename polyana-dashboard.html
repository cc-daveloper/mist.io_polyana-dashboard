- t
<link rel="import" href="../../bower_components/polymer-sortablejs/polymer-sortablejs.html"/>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/timerange-picker/timerange-picker.html">
<link rel="import" href="dashboard-row.html">
<dom-module id="polyana-dashboard">
    <template>
      <style>
        :host{
          /*text-align: center;*/
        }
        body {
          padding: 20px;
        }

        .list-group-item {
          cursor: move;
          cursor: -webkit-grabbing;
        }
      </style>
      <style is="custom-style">
    :host{
      --primary-text-color: blue;
      --paper-input-container-label: {
          color:orange;
      }
    }
</style>
    <!--  <paper-button on-tap="postData">Post Data</paper-button> -->
      <timerange-picker from="{{from}}" to="{{to}}"></timerange-picker>

      <paper-dropdown-menu label="Select an item" placeholder="off" >
        <paper-menu class="dropdown-content" selected="1" attr-for-selected="data-value">
          <paper-item data-value="1">off</paper-item>
          <paper-item data-value="2">5s</paper-item>
          <paper-item data-value="3">10s</paper-item>
          <paper-item data-value="4">30s</paper-item>
        </paper-menu>
      </paper-dropdown-menu>

      <iron-ajax
        id="dataAjax"
        url="/api/dashboards/db"
        handle-as="json"
        method="post"
        on-response="postComplete"
        debounce-duration="300"></iron-ajax>
      <sortable-js>
        <template is="dom-repeat" items="{{dashboard.rows}}">
          <dashboard-row  class="row" datasources="[[datasources]]" row="[[item]]" replace-targets="[[replaceTargets]]" style="height: [[item.height]]*2; clear: both; display: block" from="[[dashboard.time.from]]" to="[[dashboard.time.to]]" id="row-{{index}}" ></dashboard-row>
        </template>
      </sortable-js>
      <iron-ajax auto="[[uri]]"
        url="/api/dashboards/[[uri]]"
        handle-as="json"
        method="GET"
        on-response="_handleResponse"
        debounce-duration="300"></iron-ajax>
    </template>
    <script>
        Polymer({
          is: 'polyana-dashboard',

          properties: {
            uri: {
              type: String
            },
            dashboard: {
              type: Object
            },
            datasources: {
              type: Array
            },
            meta: {
              type: Object
            },
            targets: {
              type: Array,
              computed: "_getTargets(dashboard, datasources)"
            },
            datapoints: {
              type: Object
            },
            from: {
              type: String
            },
            to: {
              type: String
            },
            replaceTargets: {
                type: Object,
                value: {}
            },
          },
          listeners: {
            "timechanged": "_getData",
            'end': '_orderChanged',
          },

          _orderChanged: function(e){
            console.log(this.dashboard);
            this.$.dataAjax.headers["Content-Type"] = 'application/json';
            this.$.dataAjax.body = {
              dashboard: this.dashboard,
              overwrite: true
            };
            this.$.dataAjax.generateRequest();
          },
          autoRefresh: function (){
            console.log("peos");
          },
          //postData: function(){

          //},
          //postComplete:function (){
            //console.log("post Complete");
          //},
            _getData: function(e){

              var from = e.detail.from;
              var to = e.detail.to;
              var targetParams = '';
              for (var i = 0; i < this.targets.length; i++)
                if (this.targets[i].target){
                  targetParams += '&target=' + this.targets[i].target
                }
                var Fday=from.substr(0,2);
                var Fmonth= from.substr(3,2);
                var Fyear=from.substr(6,4);

                var Tday=to.substr(0,2);
                var Tmonth= to.substr(3,2);
                var Tyear=to.substr(6,4);


                var temp = document.querySelectorAll("dashboard-panel");
                for(var j=0; j<temp.length; j++){
                  temp[j].DateChange(Fyear,Fmonth,Fday,Tyear,Tmonth,Tday);
                }

            },
          _handleResponse: function (data) {
              this.meta = data.detail.response.meta;
              this.dashboard = data.detail.response.dashboard;
          },

          _getTargets: function (dashboard, datasources) {
              var targets = {};
              for (var i=0; i<dashboard.rows.length; i++) {
                if (dashboard.rows[i].panels)
                  for (var j=0; j<dashboard.rows[i].panels.length; j++)
                    if (dashboard.rows[i].panels[j] && dashboard.rows[i].panels[j].targets)
                      for (var k=0; k < dashboard.rows[i].panels[j].targets.length; k++) {
                        if(dashboard.rows[i].panels[j].datasource==null){
                            for(var p=0; p<datasources.length; p++){
                              if(datasources[p].isDefault){
                                dashboard.rows[i].panels[j].datasource=datasources[p];
                                //break;
                             }
                            }
                          }
                          if (dashboard.rows[i].panels[j].datasource && targets[dashboard.rows[i].panels[j].datasource] == undefined){
                            targets[dashboard.rows[i].panels[j].datasource] = [];
                          }
                          if (dashboard.rows[i].panels[j].targets[k].target && targets[dashboard.rows[i].panels[j].datasource].indexOf(dashboard.rows[i].panels[j].targets[k].target)==-1){
                            targets[dashboard.rows[i].panels[j].datasource].push(dashboard.rows[i].panels[j].targets[k].target);
                          }
                      }
              }

              return targets
          }
      });

    </script>
</dom-module>
