<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../timerange-picker/timerange-picker.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="dashboard-row.html">

<dom-module id="polyana-dashboard">
    <template>
      <style>
        :host{
          display: block;
        }
        body {
          padding: 20px;
        }
        .list-group-item {
          cursor: move;
          cursor: -webkit-grabbing;
        }
        paper-material {
          width: 100%;
          padding: 8px 0;
          box-sizing: border-box;
        }
        .timerange-area {
            justify-content: flex-end;
        }
      </style>
      <style is="custom-style">
        paper-card {
          padding: 16px;
          margin: 16px;
        }
    </style>
    <paper-material class="timerange-area layout horizontal stretch" elevation="0">
        <timerange-picker from="{{from}}" to="{{to}}" refresh-interval="{{refreshInterval}}"></timerange-picker>
    </paper-material>
        <iron-ajax
            id="dataAjax"
            url="/api/v1/dashboards/db"
            handle-as="json"
            method="post"
            debounce-duration="300"></iron-ajax>
        <template is="dom-repeat" items="{{dashboard.rows}}">
            <dashboard-row  class="row" datasources="[[datasources]]" refresh-interval="{{refreshInterval}}" row="{{item}}" style="height: [[item.height]]*2; clear: both; display: block" from="{{from}}" to="{{to}}" id="row-{{index}}" ></dashboard-row>
        </template>
        <iron-ajax
            id='requestAjax'
            auto="[[uri]]"
            url="[[uri]]"
            handle-as="json"
            method="GET"
            on-response="_handleResponse"
            debounce-duration="300">
        </iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'polyana-dashboard',

            properties: {
                dashboardPath: {
                    type: String
                },
                dashboard: {
                    type: Object,
                    observer: '_dashboardUpdated'
                },
                datasources: {
                    type: Array
                },
                meta: {
                    type: Object
                },
                targets: {
                    type: Array,
                    computed: "_getTargets(dashboard, datasources)"
                },
                datapoints: {
                    type: Object
                },
                from: {
                    type: String
                },
                to: {
                    type: String
                },
                refreshInterval: {
                    type: Number,
                    value: 0,
                },
            },
            listeners: {
                'end': '_saveDashboard',
                'resizeDone': '_saveDashboard',
                'graphChanged': '_saveDashboard',
            },
            _saveDashboard: function(e) {
                if (this.dashboardPath) {
                    this.$.dataAjax.headers["Content-Type"] = 'application/json';
                    this.$.dataAjax.body = {
                        dashboard: this.dashboard,
                        overwrite: true
                    };
                    this.$.dataAjax.generateRequest();
                } else {
                    // TODO
                }
            },

            _handleResponse: function(data) {
                if (this.dashboard != null && (this.dashboard.id != data.detail.response.dashboard.id)) {
                    this.refreshInterval=0;
                }
                this.meta = data.detail.response.meta;
                this.dashboard = data.detail.response.dashboard;
            },

            _dashboardUpdated: function(){
                this.from = this.dashboard.time.from;
                this.to = this.dashboard.time.to;
            },

            _getTargets: function(dashboard, datasources) {
                var targets = {}, defaultDatasource;
                for (var i = 0; i < dashboard.rows.length; i++) {
                    if (dashboard.rows[i].panels)
                        for (var j = 0; j < dashboard.rows[i].panels.length; j++)
                            if (dashboard.rows[i].panels[j] && dashboard.rows[i].panels[j].targets)
                                for (var k = 0; k < dashboard.rows[i].panels[j].targets.length; k++) {
                                    if (dashboard.rows[i].panels[j].datasource == null) {
                                        for (var p = 0; p < datasources.length; p++) {
                                            if (datasources[p].isDefault) {
                                                defaultDatasource = datasources[p].name;
                                            }
                                        }
                                    }
                                    if (dashboard.rows[i].panels[j].datasource && targets[dashboard.rows[i].panels[j].datasource] == undefined) {
                                        targets[dashboard.rows[i].panels[j].datasource] = [];
                                    }
                                    if (!dashboard.rows[i].panels[j].datasource && targets[defaultDatasource] == undefined) {
                                        targets[defaultDatasource] = [];
                                    }
                                    var datasource = dashboard.rows[i].panels[j].datasource || defaultDatasource;
                                    if (dashboard.rows[i].panels[j].targets[k].target && targets[datasource].indexOf(dashboard.rows[i].panels[j].targets[k].target) == -1) {
                                        targets[datasource].push(dashboard.rows[i].panels[j].targets[k].target);
                                    }
                                }
                }
                return targets
            },
        });

    </script>
</dom-module>
