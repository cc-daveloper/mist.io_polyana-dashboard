<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/polymer-sortablejs/polymer-sortablejs.html" />
<link rel="import" href="dashboard-panel.html">

<dom-module id="dashboard-row">
    <template>
        <style>
             :host {
                border-collapse: collapse;
                width: 100%;
                display: inline-block;
            }
            
            body {
                padding: 20px;
            }
            
            .list-group-item {
                cursor: move;
                cursor: -webkit-grabbing;
            }
            
            dashboard-panel {
                display: block;
            }
        </style>
        <div>
            <template is="dom-if" if="[[row.showTitle]]">
                <h2 id="show">[[row.title]]</h2>
            </template>
            <sortable-js>
                <template is="dom-repeat" items="{{row.panels}}">
                    <dashboard-panel id="panel-[[item.id]]" index="[[index]]" refresh-interval="{{refreshInterval}}" datasource-uri="[[_computeDatasourceUri(datasources, item)]]" datasource-type="[[_computeDatasourceType(datasources, item)]]" row-height="{{row.height}}" panel="[[item]]" from="[[from]]" to="[[to]]" replace-targets="[[replaceTargets]]" style$="width: {{_elementWidth(item.span)}}; min-width: 300px"></dashboard-panel>
                </template>
            </sortable-js>
        </div>
    </template>
    <script>
        Polymer({
            is: 'dashboard-row',

            properties: {
                row: {
                    type: Object,
                },
                title: String,
                from: String,
                to: String,
                refreshInterval: Number,
                index: Number,
                replaceTargets: Object
            },
            listeners: {
                //'delete-panel': 'deletePanel'
            },
            deletePanel: function(e) {
                this.splice("row.panels", e.detail.index, 1);
                if (this.row.panels.length > 0)
                    this.redistributeSpace();
                if (this.row.panels.length == 0)
                    this.fire('delete-row', {
                        rowlId: this.row.id,
                        index: this.index
                    })
            },
            redistributeSpace: function(panel) {
                var totalSpan = 0;
                for (var j = 0; j < this.row.panels.length; j++) {
                    totalSpan += this.row.panels[j].span;
                }
                var diffSpan = (12 - totalSpan) / this.row.panels.length;
                for (var i = 0; i < this.row.panels.length; i++) {
                    this.row.panels[i].span += diffSpan;
                    this.querySelector("#panel-" + this.row.panels[i].id).style.width = this._elementWidth(this.row.panels[i].span);
                    this.querySelector("#panel-" + this.row.panels[i].id).chartElement.resize(this.querySelector("#panel-" + this.row.panels[i].id).style.width);
                }
            },
            _elementWidth: function(span) {
                return 100 * span / 12 + '%';
            },
            _computeDatasource: function(datasources, panel) {
                if (!panel)
                    return
                for (var i = 0; i < datasources.length; i++) {
                    if (!panel.datasource && datasources[i].isDefault)
                        return datasources[i];
                    if (panel.datasource == datasources[i].name)
                        return datasources[i];
                }
            },
            _computeDatasourceUri: function(datasources, panel) {
                var datasource = this._computeDatasource(datasources, panel);
                if (!datasource)
                    return;
                var prefix = '/api/datasources/proxy/';
                return datasource.uri || prefix + datasource.id;
            },
            _computeDatasourceType: function(datasources, panel) {
                var datasource = this._computeDatasource(datasources, panel);
                if (!datasource)
                    return
                return datasource.type;
            }
        });
    </script>
</dom-module>